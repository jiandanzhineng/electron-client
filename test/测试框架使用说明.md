# 游戏测试框架使用说明

## 快速开始

```bash
# 运行所有测试
npm test

# 详细输出模式
npm run test:verbose

# 运行特定测试
npm run test:pushup

# 监视模式
npm run test:watch
```

## 框架特性

- **自动化测试** - 无需手工操作，自动验证游戏逻辑
- **设备模拟** - 完整模拟QTZ、自动锁、电击器、跳蛋等设备
- **断言方法** - 提供equal、isTrue、inRange、throws等断言
- **测试夹具** - 支持setup/teardown生命周期
- **详细报告** - 生成完整的测试统计和错误信息

## 核心文件

- `game-test-framework.js` - 测试框架核心
- `mock-device-manager.js` - 设备模拟器
- `run-tests.js` - 测试运行器
- `test-config.json` - 测试配置

## 当前测试覆盖

### 俯卧撑游戏测试 (pushup-game-tests.js)

- ✅ 游戏初始化和参数更新
- ✅ 俯卧撑动作检测和计数
- ✅ 惩罚机制（无动作电击）
- ✅ 奖励机制（连续完成跳蛋）
- ✅ 设备断开连接处理
- ✅ 游戏超时和边界条件
- ✅ 高频事件处理
- ✅ 批量俯卧撑序列

## 编写测试用例

```javascript
const framework = new GameTestFramework();

framework.addTest('测试名称', async (assert) => {
    // 测试逻辑
    assert.equal(actual, expected);
});

framework.addFixture('夹具名称', {
    setup: async () => {
        // 初始化
        return gameInstance;
    },
    teardown: async (gameInstance) => {
        // 清理
        await gameInstance.endGame();
    }
});
```

## 设备模拟

```javascript
const mockDeviceManager = new MockDeviceManager();

// 模拟设备连接
mockDeviceManager.simulateDeviceConnection('QTZ', { distance: 100 });

// 模拟俯卧撑动作
mockDeviceManager.simulatePushupSequence(5, 2000);

// 检查MQTT消息
const messages = mockDeviceManager.getMqttHistory();
```

## 配置选项

在 `test-config.json` 中配置：

- `testTimeout` - 测试超时时间
- `maxConcurrency` - 并发测试数
- `retryCount` - 失败重试次数
- `mockDevices` - 默认模拟设备
- `gameDefaults` - 游戏默认参数

## 测试报告

测试完成后显示：
- 总测试数、通过数、失败数
- 成功率百分比
- 详细错误信息和堆栈跟踪
- 执行时间统计