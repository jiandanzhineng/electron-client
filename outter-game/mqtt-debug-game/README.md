# MQTT调试工具

## 概述

MQTT调试工具是一个专门用于监控和调试设备MQTT消息的外部玩法。它可以实时显示所有设备的MQTT消息，帮助开发者分析消息延迟、丢失和处理性能问题。

## 功能特性

### 🔍 实时消息监控
- 实时显示所有设备MQTT消息
- 支持原始载荷和解析后的JSON格式显示
- 自动过滤设备上报消息（/dpub/开头）
- 消息历史记录（可配置最大数量）

### 📊 性能分析
- 消息处理延迟监控
- 设备消息统计（消息数量、频率、错误数等）
- 延迟阈值警告
- 实时性能指标显示

### 🎛️ 可配置参数
- **最大消息数量**: 界面显示的最大消息历史数量（100-5000）
- **显示原始载荷**: 是否显示完整的原始MQTT载荷数据
- **仅显示设备消息**: 仅显示/dpub/开头的设备上报消息
- **高亮延迟消息**: 高亮显示处理时间超过阈值的消息
- **延迟阈值**: 消息处理延迟的警告阈值（10-1000ms）

## 使用方法

### 1. 启动调试工具
1. 在游戏列表中选择"MQTT调试工具"
2. 配置相关参数（可选）
3. 点击"开始游戏"启动监控

### 2. 界面说明

#### 统计面板
- **运行时间**: 工具运行的总时间
- **消息总数**: 接收到的MQTT消息总数
- **消息速率**: 每秒接收的消息数量
- **活跃设备**: 当前有消息上报的设备数量

#### 设备统计
显示每个设备的详细统计信息：
- 消息数量
- 平均处理延迟
- 最大处理延迟
- 错误数量
- 最后消息时间

#### 消息历史
显示最近的MQTT消息记录：
- 消息主题（topic）
- 接收时间
- 消息载荷
- 处理时间
- 解析错误（如有）

### 3. 延迟分析

#### 延迟类型
1. **网络延迟**: MQTT broker到客户端的传输延迟
2. **IPC延迟**: 主进程到渲染进程的通信延迟
3. **处理延迟**: 消息解析和处理的计算延迟
4. **队列延迟**: 消息在队列中等待处理的时间

#### 延迟优化建议
- 如果网络延迟高，检查MQTT broker连接质量
- 如果处理延迟高，考虑优化消息处理逻辑
- 如果队列延迟高，可能需要增加批处理大小或处理频率

## 技术实现

### 消息处理流程
1. **消息接收**: 通过electronAPI.onMqttMessage监听MQTT消息
2. **消息过滤**: 根据配置过滤设备消息
3. **性能监控**: 记录消息接收和处理时间
4. **统计更新**: 更新设备和全局统计信息
5. **UI渲染**: 实时更新界面显示

### 性能优化
- 使用消息队列避免阻塞主线程
- 批量处理消息提高效率
- 限制历史记录大小防止内存泄漏
- 使用requestAnimationFrame优化渲染性能

## 故障排除

### 常见问题

#### 1. 没有收到消息
- 检查MQTT连接状态
- 确认设备是否正常上报
- 检查消息过滤设置

#### 2. 消息延迟过高
- 检查网络连接质量
- 查看系统资源使用情况
- 调整延迟阈值设置

#### 3. 界面卡顿
- 减少最大消息数量
- 关闭原始载荷显示
- 启用设备消息过滤

### 调试技巧
1. 使用浏览器开发者工具查看控制台日志
2. 监控内存使用情况
3. 对比不同配置下的性能表现
4. 记录特定时间段的消息模式

## 版本历史

### v1.0.0
- 初始版本
- 基本的MQTT消息监控功能
- 设备统计和性能分析
- 可配置的显示选项
- 延迟检测和警告

## 开发说明

### 文件结构
```
outter-game/
├── mqtt-debug-game.js    # 主要实现文件
└── mqtt-debug-game/
    └── README.md          # 说明文档
```

### 依赖关系
- 依赖electronAPI进行MQTT消息监听
- 使用gameplayUI进行界面渲染
- 集成到现有的游戏框架中

### 扩展建议
1. 添加消息导出功能
2. 支持消息重放
3. 添加更多统计图表
4. 支持自定义过滤规则
5. 添加消息搜索功能